{
    "description": "CoreOS image for a VirtualBox platform.",

    "builders": [{
        "type": "virtualbox-iso",
            
        "vm_name": "vm-{{timestamp}}-packer",
        "iso_checksum": "{{user `virtualbox_img_iso_checksum`}}",
        "iso_checksum_type": "{{user `virtualbox_img_iso_checksum_type`}}",
        "iso_url": "{{user `virtualbox_img_iso_url`}}",
        "iso_target_path": "{{user `global_build_directory`}}/{{user `virtualbox_img_name`}}-{{user `virtualbox_img_release`}}-{{user `virtualbox_img_version`}}.iso", 
        "guest_os_type": "Linux26_64",
        
        "hard_drive_interface": "sata",
        "disk_size": "{{user `virtualbox_disk_size`}}",
        "vboxmanage": [
            ["modifyvm", "{{.Name}}", "--cpus", "{{user `virtualbox_cpus`}}"],
            ["modifyvm", "{{.Name}}", "--memory", "{{user `virtualbox_memory`}}"]
        ],
    
        "headless": "false",
        "guest_additions_mode": "disable",
        "output_directory": "{{user `global_build_directory`}}/packer-vm-cache",
        
        "http_directory": "{{user `global_working_directory`}}",
        "boot_wait": "33s",
        "boot_command": [
            "sudo -i;<enter>",
            "systemctl stop sshd.socket;<enter>",
            "wget http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{user `virtualbox_user_data_path`}}/{{user `virtualbox_user_data_file`}};<enter>",
            "cat {{user `virtualbox_user_data_file`}};<enter>",
            "coreos-install -d /dev/sda -C {{ user `virtualbox_img_release` }} -V {{ user `virtualbox_img_version` }} -i {{user `virtualbox_user_data_file`}};<enter>",
            "echo 'A small custom image, a huge leap for provisioning...';<enter>",
            "echo '...The system will RESTART in 7 seconds......';<enter>",
            "sleep 7s;<enter>",
            "reboot;<enter>"
        ],

        "communicator": "ssh",
        "ssh_port": 22,
        "ssh_username": "{{user `cred_vagrant_username`}}",
        "ssh_private_key_file": "{{user `global_working_directory`}}/{{user `cred_vagrant_private_key_path`}}/{{user `cred_vagrant_private_key_file`}}",
        "ssh_timeout": "33m",
    
        "shutdown_command": "sudo -S shutdown -P now"
    }],

    "provisioners": [
        {
            "type": "shell",
            "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
            "inline": [
                "mkdir -p  {{user `global_image_deployment_directory`}}/ssl-certificates",
                "chmod 777 {{user `global_image_deployment_directory`}}/ssl-certificates"
            ]
        },
        {
            "type": "file",
            "source": "{{user `global_working_directory`}}/provision/ssl-certificates/deploy_public_key.pub",
            "destination": "{{user `global_image_deployment_directory`}}/ssl-certificates/deploy_public_key.pub"
        },
        {
            "type": "shell",
            "execute_command": "{{ .Vars }} sudo -E -S sh '{{ .Path }}'",
            "environment_vars" : [
                "PACKER_LOG_FILES_DIR={{user `global_image_log_directory`}}",
                "PACKER_DEPLOYMENT_DIR={{user `global_image_deployment_directory`}}",
                
                "PACKER_PYTHON_VERSION={{user `global_python_version`}}",
                "PACKER_CNI_PLUGIN_VERSION={{user `global_cni_plugin_version`}}",
                "PACKER_PEERVPN_VERSION={{user `global_peervpn_version`}}",
                "PACKER_RKT_VERSION={{user `global_rkt_version`}}",
                "PACKER_DOCKER_VERSION={{user `global_docker_version`}}",
                "PACKER_DOCKER_COMPOSE_VERSION={{user `global_docker_compose_version`}}",
                "PACKER_ETCD_VERSION={{user `global_etcd_version`}}",
                "PACKER_FLANNEL_VERSION={{user `global_flannel_version`}}",
                "PACKER_KUBERNETES_VERSION={{user `global_kubernetes_version`}}"
            ],
            "scripts": [
                "{{user `global_working_directory`}}/provision/shell-scripts/config-system.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-security.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-access-user.sh",

                "{{user `global_working_directory`}}/provision/shell-scripts/config-python.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-cni-plugin.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-peervpn.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-rkt.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-docker.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-docker-compose.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-etcd.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-flannel.sh",
                "{{user `global_working_directory`}}/provision/shell-scripts/config-kubernetes.sh",

                "{{user `global_working_directory`}}/provision/shell-scripts/config-finalize.sh"
            ]
        }
    ],

    "post-processors": [{
        "type": "vagrant",
        "compression_level": "6",
        "output": "{{user `global_build_directory`}}/{{user `virtualbox_vagrant_box_file`}}"
    }],

    "min_packer_version": "1.1.3"
}